<link rel="stylesheet" href="{{ url_for('static', filename='parliament/election_style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<div class="moving-avg-container">
    <div class="election-container">
        <h1 style="direction: rtl; text-align: right;">ממוצע 5 הסקרים האחרונים</h1>
        <canvas id="pollBarChart" width="100%"></canvas>
    </div>
    
    <div class="block-container">
        <h2 style="direction: rtl; text-align: right;">חלוקה לגושים</h2>
        <div class="block-bar" dir="rtl">
            {% set total_seats = block_seats | sum %}
            {% for i in range(block_labels|length) %}
                {% set block = block_labels[i] %}
                {% set seats = block_seats[i] %}
                {% set color = block_colors[i] %}
                {% set width = (seats / total_seats * 100) | round(2) %}
                <div class="block-segment"
                     style="width: {{ width }}%; background: {{ color }};">
                    <div class="block-label">
                        <span class="block-name">{{ block }}</span>
                        <span class="block-seats">{{ seats }}</span>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
<div class="poll-history-container">
    <h2 style="direction: rtl; text-align: right;">ממוצע מנדטים בסקרים</h2>
    <canvas id="pollHistoryChart" width="100%"></canvas>
</div>
<div class="poll-party-lines-container">
    <h2 style="direction: rtl; text-align: right;">מנדטים לכל מפלגה בכל סקר</h2>
    <canvas id="pollPartyLineChart" width="100%"></canvas>
</div>
<div class="news-feed-container">
    <!-- insert news feed rss here -->
</div>

<script src="{{ url_for('static', filename='js/party_colors.js') }}"></script>
<script>
    const partyLabels = {{ party_labels|tojson }};
    const partySeats = {{ party_seats|tojson }};
    const partyColors = {{ party_colors|tojson }};

    const ctx = document.getElementById('pollBarChart').getContext('2d');

    let chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: partyLabels,
            datasets: [{
                label: 'מספר מנדטים',
                data: partySeats,
                backgroundColor: partyColors,
                borderWidth: 0,
                borderRadius: 8,
                hoverBackgroundColor: partyColors.map(color => color + '95')
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                title: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'start',
                    color: '#fff',
                    font: { weight: 'bold', size: 24 },
                    formatter: function(value) {
                        return value;
                    },
                    offset: 0,
                    clip: true
                }
            },
            layout: {
                padding: { bottom: 30 }
            },
            scales: {
                x: {
                    grid: { display: false, drawBorder: false },
                    ticks: {
                        font: { size: 14, weight: 'bold' },
                        color: '#222'
                    }
                },
                y: {
                    display: false,
                    grid: { display: false, drawBorder: false }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    const pollDates = {{ poll_dates|tojson }};
    const allPartyNames = {{ all_party_names|tojson }};
    const allPartyColors = {{ all_party_colors|tojson }};
    const pollPartySeats = {{ poll_party_seats|tojson }};

    // Build datasets for Chart.js
    const pollHistoryDatasets = allPartyNames.map((party, idx) => ({
        label: party,
        data: pollPartySeats[idx],
        backgroundColor: allPartyColors[idx],
        borderWidth: 0
    }));

    const pollHistoryCtx = document.getElementById('pollHistoryChart').getContext('2d');
    new Chart(pollHistoryCtx, {
        type: 'bar',
        data: {
            labels: pollDates,
            datasets: pollHistoryDatasets
        },
        options: {
            animation: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: true, position: 'right', labels: { font: { size: 14 } } },
                title: { display: false }
            },
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                    min: 0,
                    max: 120,
                    ticks: {
                        callback: function(value) { return value + ' מנדטים'; },
                        font: { size: 12 }
                    }
                },
                y: {
                    stacked: true,
                    ticks: { font: { size: 12 } }
                }
            }
        }
    });

    // New column chart for party seats per poll (stacked columns)
   
    const pollPartyColumnCtx = document.getElementById('pollPartyLineChart').getContext('2d');
    const partyColumnDatasets = allPartyNames.map((party, idx) => ({
        label: party,
        data: pollPartySeats[idx],
        backgroundColor: getPartyColor(party),
        borderWidth: 0
    }));

    new Chart(pollPartyColumnCtx, {
        type: 'bar',
        data: {
            labels: pollDates,
            datasets: partyColumnDatasets
        },
        options: {
            animation: false,   
            plugins: {
                legend: { display: true, position: 'right', labels: { font: { size: 14 } } },
                title: { display: false }
            },
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                    title: { display: true, text: 'תאריך סקר' },
                    ticks: { font: { size: 12 } }
                },
                y: {
                    stacked: true,
                    min: 0,
                    max: 120,
                    title: { display: true, text: 'מספר מנדטים' },
                    ticks: { font: { size: 12 } }
                }
            }
        }
    });
</script>



