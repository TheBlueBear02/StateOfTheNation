
<link rel="stylesheet" href="{{ url_for('static', filename='offices_style.css') }}">
<span class="explain_span"><img class="explain_icon" style="width: 2vw;display: block;margin: auto;margin-top: 2px;" src="/static/images/offices/question_mark.png"></span>

<table id="main_table">
    <tr>
        <td>
            {% set first_office = offices[0] %}
            <table class="up-left">              
                <tr><td></td><td><div class="transform_div"><span id="0" class="kpi" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 5.5vw; height: 5.5vw;"><img class="bubble_icon" style="width: 4vw;" src="/static/images/offices/white_bag.png"></span></div></td><td><div class="transform_div"><span id="1" class="kpi" data-tooltip="{{first_office_indexes[1]['name']}}" style="width: 3.5vw; height: 3.5vw;"><img class="bubble_icon" style="width: 2.5vw;" src="/static/images/offices/white_bag.png"></span></div></td><td></td></tr>
                <tr>         <td><div class="transform_div"><span id="2" class="kpi" data-tooltip="{{first_office_indexes[2]['name']}}" style="width: 3.5vw; height: 3.5vw;"><img class="bubble_icon" style="width: 2.5vw;" src="/static/images/offices/white_bag.png"></span></div></td><td><div class="transform_div"><span id="3" class="alert_bubble" data-tooltip="{{first_office_indexes[3]['name']}}" style="width: 4.5vw; height: 4.5vw;"><img class="bubble_icon" style="width: 3vw;" src="/static/images/offices/white_bag.png"></span></div></td><td><div class="transform_div"><span id="4" class="kpi" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 5.5vw; height: 5.5vw;"><img class="bubble_icon" style="width: 4vw;" src="/static/images/offices/white_bag.png"></span></td><td><div class="transform_div"><span id="7" class="policy" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 4.5vw; height: 4.5vw;"><img class="bubble_icon" style="width: 3vw;" src="/static/images/offices/grey_bag.png"></span></div></td></tr>
                <tr>         <td><div class="transform_div"><span id="5" class="kpi" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 4.5vw; height: 4.5vw;"><img class="bubble_icon" style="width: 3vw;" src="/static/images/offices/white_bag.png"></span></div></td><td><div class="transform_div"><span id="6" class="kpi" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 5.5vw; height: 5.5vw;"><img class="bubble_icon" style="width: 4vw;" src="/static/images/offices/white_bag.png"></span></div></td><td><div class="transform_div"><span id="8" class="policy" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 4.5vw; height: 4.5vw;"><img class="bubble_icon" style="width: 3vw;" src="/static/images/offices/grey_bag.png"></span></div></td><td><div class="transform_div"><span id="9" class="policy" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 3.5vw; height: 3.5vw;"><img class="bubble_icon" style="width: 2.5vw;" src="/static/images/offices/grey_bag.png"></span></div></td></tr>
                <tr><td></td><td><div class="transform_div"><span id="10"class="policy" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 3.5vw; height: 3.5vw;"><img class="bubble_icon"  style="width: 2.5vw;" src="/static/images/offices/grey_bag.png"></span></div></td><td><div class="transform_div"><span id="11" class="policy" data-tooltip="{{first_office_indexes[0]['name']}}" style="width: 3.5vw; height: 3.5vw;"><img class="bubble_icon" style="width: 2.5vw;" src="/static/images/offices/grey_bag.png"></span></div></td><td><span class="main_bubble" id="main_upper_left" data-tooltip="{{offices[0]["name"]}}" style="background-image: url({{offices[0]['minister_image']}}); background-size: cover; border: 1px solid grey;"></span></td></tr>
            </table>
        </td>
        <td>
            {% set second_office = offices[1] %}
            <table class="up-right" style="border-bottom: 6px solid; border-image-slice: 1; border-width: 0.8vh;  border-image-source: linear-gradient(to right, #838383, #ffffff);">
                {% for row in second_office_cells %}
                <tr>
                    {% for cell in row %}
                        {% if cell.cell_type == "space" %}
                            <td></td>
                        {% elif cell.cell_type == "main_bubble" %}
                            <td>
                                <span class="main_bubble" id="main_upper_right" data-tooltip="{{second_office['name']}}" style="background-image: url({{second_office['minister_image']}});"></span>
                            </td>
                        {% else %}
                            <td>
                                <div class="transform_div">
                                    <span 
                                        class="{{ cell.size }} {% if cell.alert %} alert_bubble {% else %} {{ cell.cell_type }} {% endif %}"
                                        data-tooltip="{{ cell.name }}"
                                        data-name="{{ cell.name }}"
                                        data-info="{{ cell.info }}"
                                        data-chart="{{ cell.chart_type }}"
                                        data-labels="{{ cell.labels}}"
                                        data-values="{{ cell.values | tojson }}"
                                        onclick="openModal(this)">
                                        <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/white_bag.png" alt="{{ cell.name }}">
                                    </span>
                                </div>
                            </td>
                            <script>
                                console.log("Labels:", "{{ cell.labels}}");
                                console.log("Values:", "{{ cell.labels}}");
                            </script>
                        {% endif %}
                    {% endfor %}
                    </tr>
                {%endfor%}
                <!--<tr><td></td><td><div class="transform_div"><span  class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 5.5vw; height: 5.5vw;"></span></div></td></tr>
                <tr>         <td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 4.5vw; height: 4.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 4.5vw; height: 4.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 4.5vw; height: 4.5vw;"></span></div></td></tr>
                <tr>         <td><div class="transform_div"><span class="policy" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><div class="transform_div"><span class="policy" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 5.5vw; height: 5.5vw;"></span></div></td></tr>
                <tr>         <td><span class="main_bubble" id="main_upper_right" data-tooltip="{{second_office["name"]}}" style="background-image: url({{second_office['minister_image']}}); background-size: cover;border: 1px solid grey;"></span></td><td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></div></td><td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></div></td><td></td></tr> -->
            </table>
        </td>
    </tr>
    <tr>
        <td>
            {% set third_office = offices[2] %}
            <table class="down-left" style="border-top: 6px solid; border-image-slice: 1; border-width: 0.8vh;  border-image-source: linear-gradient(to left, #838383, #ffffff);">
                <tr><td></td><td><div class="transform_div"><span class="policy" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><div class="transform_div"><span class="policy" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><span class="main_bubble" id="main_down_left" data-tooltip="{{third_office["name"]}}" style="background-image: url({{third_office['minister_image']}}); background-size: cover;border: 1px solid grey;"></span></td></tr>
                <tr>         <td><div class="transform_div"><span class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 4.5vw; height: 4.5vw;"></span></div></td><td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></div></td><td><div class="transform_div"><span class="policy" style="width: 3.5vw; height: 3.5vw;"></span></div></td></tr>
                <tr>         <td><div class="transform_div"><span class="kpi" style="width: 5.5vw; height: 5.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 4.5vw; height: 4.5vw;"></span></div></td><td><div class="transform_div"><span class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></div></td></tr>
                <tr><td></td><td><div class="transform_div"><span class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></div></td><td><div class="transform_div"><span class="alert_bubble" style="width: 5.5vw; height: 5.5vw;"></span></div></td><td></td></tr>
            </table>
        </td>
        <td>
            {% set forth_office = offices[3] %}
            <table class="down-right" style="border-left: 6px solid; border-image-slice: 1; border-width: 0.8vh;  border-image-source: linear-gradient( #838383, #ffffff);">
                <tr>         <td><span class="main_bubble" id="main_down_right" data-tooltip="{{forth_office["name"]}}" style="background-image: url({{forth_office['minister_image']}}); background-size: cover;border: 1px solid grey;"></span></td><td><div class="transform_div"><span class="policy" style="width: 3.5vw; height: 3.5vw;"></span></td><td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></td><td></td></tr>
                <tr>         <td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></td><td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></td><td><div class="transform_div"><span class="kpi" style="width: 4.5vw; height: 4.5vw;"></span></td><td><div class="transform_div"><span class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></td></tr>
                <tr>         <td><div class="transform_div"><span class="policy" style="width: 4.5vw; height: 4.5vw;"></span></td><td><div class="transform_div"><span class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></td><td><div class="transform_div"><span class="kpi" style="width: 4.5vw; height: 4.5vw;"></span></td><td><div class="transform_div"><span class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></td></tr>
                <tr><td></td><td><div class="transform_div"><span class="kpi" style="width: 3.5vw; height: 3.5vw;"></span></td><td><div class="transform_div"><span class="kpi" style="width: 5.5vw; height: 5.5vw;"></span></td><td></td></tr>
            </table>
        </td>
    </tr>
</table>



<dialog kpi-modal class="kpi-modal">
    <button onclick="closeModal()" id="close_button">X</button>
    <table>
        <tr>
            <th colspan="2">
                <div>
                    <p id="modal-name-kpi" style="font-size: 1.3rem;"></p>
                </div>
                <p id="modal-info-kpi" style="font-size: 1rem;"></p>
            </th>
        </tr>
        <tr>
            <th>
                <div id="graph_div_kpi" class="chart-div">
                    <canvas id="kpi_chart"></canvas>
                </div>
            </th>
        </tr>
    </table>
</dialog>

<dialog policies-modal class="policies-modal">
    <button onclick="closeModal()" id="close_button">X</button>
    <table>
        <tr>
            <th colspan="2">
                <div>
                    <p id="modal-name-policy" style="font-size: 1.3rem;"></p>
                </div>
                <p id="modal-info-policy" style="font-size: 1rem;"></p>
            </th>
        </tr>
        <tr>
            <th>
                <div id="graph_div_policy" class="chart-div">
                    <canvas id="policies_chart"></canvas>
                </div>
            </th>
        </tr>
    </table>
</dialog>

<dialog explain-modal class="explain-modal">
    <button close_modal onclick="closeModal()" style="display: block;" id="close_button" >X</button>
    <img style="width: 145vh; height: 90vh; margin-left:6rem;" src="/static/images/offices/explain.png">
</dialog>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const kpiModal = document.querySelector("[kpi-modal]");
    const policiesModal = document.querySelector("[policies-modal]");
    const explainModal = document.querySelector("[explain-modal]");

    // Store charts in a global object to manage them easily
    const charts = {};

    function closeModal() {
        kpiModal.close();
        policiesModal.close();
        explainModal.close();

        // Destroy all active charts to clear data
        if (charts["kpi_chart"]) {
            charts["kpi_chart"].destroy();
            delete charts["kpi_chart"];
        }
        if (charts["policies_chart"]) {
            charts["policies_chart"].destroy();
            delete charts["policies_chart"];
        }
    }

    function openModal(cellElement) {
        const name = cellElement.getAttribute("data-name");
        const info = cellElement.getAttribute("data-info");
        const chart = cellElement.getAttribute("data-chart");
        const labels = JSON.parse(cellElement.getAttribute("data-labels"));
        const values = JSON.parse(cellElement.getAttribute("data-values"));
        
        console.log("values:", values);
        console.log("Labels:", labels); // Should be an array like ["Label1", "Label2", ...]
        console.log("chart type:", chart); // Should be an array like ["Label1", "Label2", ...]

        if (cellElement.classList.contains('kpi') || cellElement.classList.contains('alert_bubble')) {
            document.getElementById("modal-name-kpi").textContent = name;
            document.getElementById("modal-info-kpi").textContent = info;
            updateChart("kpi_chart", labels, values, chart);
            kpiModal.showModal();
        } else if (cellElement.classList.contains('policy')) {
            document.getElementById("modal-name-policy").textContent = name;
            document.getElementById("modal-info-policy").textContent = info;
            updateChart("policies_chart", labels, values, chart);
            policiesModal.showModal();
        }
    }

    function updateChart(chartId, labels, values, chart) {
        // Destroy existing chart if it exists
        if (charts[chartId]) {
            charts[chartId].destroy();
        }

        const ctx = document.getElementById(chartId).getContext("2d");
        charts[chartId] = new Chart(ctx, {
            type: chart,
            data: {
                labels: labels,
                datasets: [{
                    label: "Example Dataset",
                    data: values,
                    fill: true,
                    borderColor: "#4890FD",
                    backgroundColor: "rgb(208, 226, 252)",
                    borderWidth: 2,
                    lineTension: 0.5
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { 
                    grid: { display: false } } }
            }
        });
    }
</script>