
<link rel="stylesheet" href="{{ url_for('static', filename='offices_style.css') }}">
<span class="explain_span"><img class="explain_icon" style="width: 2vw;display: block;margin: auto;margin-top: 2px;" src="/static/images/offices/question_mark.png"></span>

<table id="main_table">
    <tr>
        <td>
            <!-- First Office -->
            {% set first_office = offices[0] %}
            <table class="up-left">              
                {% for row in first_office_cells %}
                <tr>
                    {% for cell in row %}
                        {% if cell.cell_type == "space" %}
                            <td></td>
                        {% elif cell.cell_type == "main_bubble" %}
                            <td>
                                <span class="main_bubble" id="main_upper_right" data-tooltip="{{first_office['name']}}" style="background-image: url({{first_office['minister_image']}});"></span>
                            </td>
                        {% else %}
                            <td>
                                <div class="transform_div">
                                    <span 
                                        class="{{ cell.size }} {% if cell.alert %} alert_bubble {% else %} {{ cell.cell_type }} {% endif %}"
                                        data-tooltip="{{ cell.name }}"
                                        data-name="{{ cell.name }}"
                                        data-info="{{ cell.info }}"
                                        data-icon="{{ cell.icon }}"
                                        data-chart="{{ cell.chart_type }}"
                                        data-labels="{{ cell.labels}}"
                                        data-values="{{ cell.values | tojson }}"
                                        
                                        office-name="{{ first_office['name'] }}" 
                                        office-minister="{{ first_office['minister_name'] }}"
                                        office-minister-image="{{ first_office['minister_image'] }}"
                                        office-minister-party="{{ first_office['minister_party'] }}"
                                        office-minister-role="{{ first_office['minister_role'] }}"
                                        onclick="openModal(this)">
                                        {% if cell.icon != "" %}
                                            <img class="bubble_icon {{ cell.size }}_icon" src="{{cell.icon}}" alt="{{ cell.name }}">
                                        {% else %}
                                            {% if cell.cell_type == "kpi" %}
                                                <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/kpi/white_bag.png" alt="{{ cell.name }}">
                                            {% else %}
                                                <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/policy/grey_bag.png" alt="{{ cell.name }}">
                                            {% endif %}
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                        {% endif %}
                    {% endfor %}
                    </tr>
                {%endfor%}
            </table>
        </td>
        <td>
            <!-- Second Office -->
            {% set second_office = offices[1] %}
            <table class="up-right" style="border-bottom: 6px solid; border-image-slice: 1; border-width: 0.8vh;  border-image-source: linear-gradient(to right, #838383, #ffffff);">
                {% for row in second_office_cells %}
                <tr>
                    {% for cell in row %}
                        {% if cell.cell_type == "space" %}
                            <td></td>
                        {% elif cell.cell_type == "main_bubble" %}
                            <td>
                                <span class="main_bubble" id="main_upper_right" data-tooltip="{{second_office['name']}}" style="background-image: url({{second_office['minister_image']}});"></span>
                            </td>
                        {% else %}
                            <td>
                                <div class="transform_div">
                                    <span 
                                        class="{{ cell.size }} {% if cell.alert %} alert_bubble {% else %} {{ cell.cell_type }} {% endif %}"
                                        data-tooltip="{{ cell.name }}"
                                        data-name="{{ cell.name }}"
                                        data-info="{{ cell.info }}"
                                        data-icon="{{ cell.icon }}"
                                        data-chart="{{ cell.chart_type }}"
                                        data-labels="{{ cell.labels}}"
                                        data-values="{{ cell.values | tojson }}"
                                        
                                        office-name="{{ second_office['name'] }}" 
                                        office-minister="{{ second_office['minister_name'] }}"
                                        office-minister-image="{{ second_office['minister_image'] }}"
                                        office-minister-party="{{ second_office['minister_party'] }}"
                                        office-minister-role="{{ second_office['minister_role'] }}"
                                        onclick="openModal(this)">
                                        {% if cell.icon != "" %}
                                            <img class="bubble_icon {{ cell.size }}_icon" src="{{cell.icon}}" alt="{{ cell.name }}">
                                        {% else %}
                                            {% if cell.cell_type == "kpi" %}
                                                <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/kpi/white_bag.png" alt="{{ cell.name }}">
                                            {% else %}
                                                <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/policy/grey_bag.png" alt="{{ cell.name }}">
                                            {% endif %}
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                        {% endif %}
                    {% endfor %}
                    </tr>
                {%endfor%}
            </table>
        </td>
    </tr>
    <tr>
        <td>
            <!-- Third Office -->
            {% set third_office = offices[2] %}
            <table class="down-left" style="border-top: 6px solid; border-image-slice: 1; border-width: 0.8vh;  border-image-source: linear-gradient(to left, #838383, #ffffff);">
                {% for row in third_office_cells %}
                <tr>
                    {% for cell in row %}
                        {% if cell.cell_type == "space" %}
                            <td></td>
                        {% elif cell.cell_type == "main_bubble" %}
                            <td>
                                <span class="main_bubble" id="main_upper_right" data-tooltip="{{third_office['name']}}" style="background-image: url({{third_office['minister_image']}});"></span>
                            </td>
                        {% else %}
                            <td>
                                <div class="transform_div">
                                    <span 
                                        class="{{ cell.size }} {% if cell.alert %} alert_bubble {% else %} {{ cell.cell_type }} {% endif %}"
                                        data-tooltip="{{ cell.name }}"
                                        data-name="{{ cell.name }}"
                                        data-info="{{ cell.info }}"
                                        data-icon="{{ cell.icon }}"
                                        data-chart="{{ cell.chart_type }}"
                                        data-labels="{{ cell.labels}}"
                                        data-values="{{ cell.values | tojson }}"
                                        
                                        office-name="{{ third_office['name'] }}" 
                                        office-minister="{{ third_office['minister_name'] }}"
                                        office-minister-image="{{ third_office['minister_image'] }}"
                                        office-minister-party="{{ third_office['minister_party'] }}"
                                        office-minister-role="{{ third_office['minister_role'] }}"
                                        onclick="openModal(this)">
                                        {% if cell.icon != "" %}
                                            <img class="bubble_icon {{ cell.size }}_icon" src="{{cell.icon}}" alt="{{ cell.name }}">
                                        {% else %}
                                            {% if cell.cell_type == "kpi" %}
                                                <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/kpi/white_bag.png" alt="{{ cell.name }}">
                                            {% else %}
                                                <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/policy/grey_bag.png" alt="{{ cell.name }}">
                                            {% endif %}
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                        {% endif %}
                    {% endfor %}
                    </tr>
                {%endfor%}
            </table>
        </td>
        <td>
            <!-- Forth Office -->
            {% set forth_office = offices[3] %}
            <table class="down-right" style="border-left: 6px solid; border-image-slice: 1; border-width: 0.8vh;  border-image-source: linear-gradient( #838383, #ffffff);">
                {% for row in forth_office_cells %}
                <tr>
                    {% for cell in row %}
                        {% if cell.cell_type == "space" %}
                            <td></td>
                        {% elif cell.cell_type == "main_bubble" %}
                            <td>
                                <span class="main_bubble" id="main_upper_right" data-tooltip="{{forth_office['name']}}" style="background-image: url({{forth_office['minister_image']}});"></span>
                            </td>
                        {% else %}
                            <td>
                                <div class="transform_div">
                                    <span 
                                        class="{{ cell.size }} {% if cell.alert %} alert_bubble {% else %} {{ cell.cell_type }} {% endif %}"
                                        data-tooltip="{{ cell.name }}"
                                        data-name="{{ cell.name }}"
                                        data-info="{{ cell.info }}"
                                        data-icon="{{ cell.icon }}"
                                        data-chart="{{ cell.chart_type }}"
                                        data-labels="{{ cell.labels}}"
                                        data-values="{{ cell.values | tojson }}"
                                        
                                        office-name="{{ forth_office['name'] }}" 
                                        office-minister="{{ forth_office['minister_name'] }}"
                                        office-minister-image="{{ forth_office['minister_image'] }}"
                                        office-minister-party="{{ forth_office['minister_party'] }}"
                                        office-minister-role="{{ forth_office['minister_role'] }}"
                                        onclick="openModal(this)">
                                        {% if cell.icon != "" %}
                                            <img class="bubble_icon {{ cell.size }}_icon" src="{{cell.icon}}" alt="{{ cell.name }}">
                                        {% else %}
                                            {% if cell.cell_type == "kpi" %}
                                                <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/kpi/white_bag.png" alt="{{ cell.name }}">
                                            {% else %}
                                                <img class="bubble_icon {{ cell.size }}_icon" src="/static/images/offices/policy/grey_bag.png" alt="{{ cell.name }}">
                                            {% endif %}
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                        {% endif %}
                    {% endfor %}
                    </tr>
                {%endfor%}
            </table>
        </td>
    </tr>
</table>


<!-- KPI Modal -->
<dialog kpi-modal class="kpi-modal">
    <div class="modal-content">
        <table class="modal-info-table">
            <tr>
                <button onclick="closeModal()" class="close_button">X</button>
                <th style="width: 60%; ">
                    <p id="modal-info-kpi" style="font-size: 1rem;"></p>
                </th>
                <th style="margin-bottom: 5vh; min-width: 50%; height: 100%; float: right;">
                    <div style="width: 100%;height: 5vh; border-bottom: 2px solid #4890FD;">
                        <p id="modal-office-kpi" style="font-size: 1.3rem; padding: 0; "><p>
                    </div>
                    <p id="modal-name-kpi" style="float: right; margin: 0;padding: 0; font-size: 1rem; "></h3>
                </th>
                <th  style="width: 5%; ">
                    <span style="height: 6vw;width: 6vw; background: radial-gradient(#6ba4fa, #447dd3); border-radius: 50%;float: left;margin: 0;">
                        <img class="bubble_icon large_icon" id="modal-icon-kpi" src="/static/images/offices/kpi/white_bag.png">
                    </span>
                </th>   
            </tr>
        </table>
        <div id="graph_div_kpi" class="chart-div">
            <canvas class="chart" id="kpi_chart"></canvas>
        </div>
        <button onclick="" class="share_button">Share</button>
    </div>
</dialog>

<!-- Policies Modal -->
<dialog policies-modal class="policies-modal">
    <div class="modal-content">
        <table class="modal-info-table">
            <tr>
                <button onclick="closeModal()" class="close_button">X</button>
                <th style="width: 60%; ">
                    <p id="modal-info-policy" style="font-size: 1rem;"></p>
                </th>
                <th style="margin-bottom: 5vh; min-width: 20%; height: 100%; float: right;">
                    <div style="width: 100%;height: 5vh; border-bottom: 2px solid #c3c3c3;">
                        <p id="modal-office-policy" style="font-size: 1.3rem; padding: 0; "><p>
                    </div>
                    <p id="modal-name-policy" style="float: right; margin: 0;padding: 0; font-size: 1rem; "></h3>
                </th>
                <th  style="width: 5%; ">
                    <span style="height: 6vw;width: 6vw; background: radial-gradient(#e3e3e3, #c3c3c3); border-radius: 50%;float: left;margin: 0;">
                        <img class="bubble_icon large_icon" id="modal-icon-policy" src="/static/images/offices/policy/grey_bag.png">
                    </span>
                </th>   
            </tr>
        </table>
        <div id="graph_div_kpi" class="chart-div">
            <canvas class="chart" id="policies_chart"></canvas>
        </div>
        <button onclick="" class="share_button">Share</button>
    </div>
</dialog>

<!-- Info Modal -->
<dialog explain-modal class="explain-modal">
    <button close_modal onclick="closeModal()" style="display: block;" id="close_button" >X</button>
    <img style="width: 145vh; height: 90vh; margin-left:6rem;" src="/static/images/offices/explain.png">
</dialog>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const kpiModal = document.querySelector("[kpi-modal]");
    const policiesModal = document.querySelector("[policies-modal]");
    const explainModal = document.querySelector("[explain-modal]");

    // Store charts in a global object to manage them easily
    const charts = {};

    function closeModal() {
        kpiModal.close();
        policiesModal.close();
        explainModal.close();

        // Destroy all active charts to clear data
        if (charts["kpi_chart"]) {
            charts["kpi_chart"].destroy();
            delete charts["kpi_chart"];
        }
        if (charts["policies_chart"]) {
            charts["policies_chart"].destroy();
            delete charts["policies_chart"];
        }
    }

    function openModal(cellElement) {
        // index info
        const name = cellElement.getAttribute("data-name");
        const info = cellElement.getAttribute("data-info");
        const chart = cellElement.getAttribute("data-chart");
        const icon = cellElement.getAttribute("data-icon");
        const labels = JSON.parse(cellElement.getAttribute("data-labels"));
        const values = JSON.parse(cellElement.getAttribute("data-values"));
        
        // office info
        const office_name = cellElement.getAttribute("office-name");
        const minister_name = cellElement.getAttribute("office-minister");
        const minister_image = cellElement.getAttribute("office-minister-image");
        const minister_party = cellElement.getAttribute("office-minister-party");
        const office_minister_role = cellElement.getAttribute("office-minister-role");

        // modals objects

        if (cellElement.classList.contains('kpi') || cellElement.classList.contains('alert_bubble')) {
            document.getElementById("modal-name-kpi").textContent = name;
            document.getElementById("modal-info-kpi").textContent = info;
            document.getElementById("modal-office-kpi").textContent = office_name;
            document.getElementById("modal-icon-kpi").src = icon;

            updateChart("kpi_chart", labels, values, chart, name);
            kpiModal.showModal();
        } else if (cellElement.classList.contains('policy')) {
            document.getElementById("modal-name-policy").textContent = name;
            document.getElementById("modal-info-policy").textContent = info;
            document.getElementById("modal-office-policy").textContent = office_name;
            document.getElementById("modal-icon-policy").src = icon;

            updateChart("policies_chart", labels, values, chart, name);
            policiesModal.showModal();
        }
    }

    function updateChart(chartId, labels, values, chart, name) {
        // Destroy existing chart if it exists
        if (charts[chartId]) {
            charts[chartId].destroy();
        }

        const ctx = document.getElementById(chartId).getContext("2d");
        charts[chartId] = new Chart(ctx, {
            type: chart,
            data: {
                labels: labels,
                datasets: [{
                    label: name,
                    data: values,
                    fill: true,
                    borderColor: "#4890FD",
                    backgroundColor: "rgb(208, 226, 252)",
                    borderWidth: 2,
                    lineTension: 0.5
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { 
                    grid: { display: false } } }
            }
        });
    }
</script>